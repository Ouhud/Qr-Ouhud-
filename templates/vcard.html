{% extends "base.html" %}

{% block title %}
  {% if mode == "form" %}Digitale Visitenkarte erstellen ‚Äì Ouhud QR{% endif %}
  {% if mode == "view" %}{{ vcard.first_name }} {{ vcard.last_name }} ‚Äì Visitenkarte{% endif %}
  {% if mode == "edit" %}vCard bearbeiten ‚Äì Ouhud QR{% endif %}
{% endblock %}

{% block content %}

<!-- ‚úÖ Ouhud QR Standard Layout -->
<section class="qr-generator vcard-generator">

  {# ============================
     MODE: FORM
     ============================ #}
  {% if mode == "form" %}

    <h1>üë§ Digitale Visitenkarte erstellen</h1>
    <p class="subtitle">
      Erstelle deine pers√∂nliche oder gesch√§ftliche digitale Visitenkarte.
    </p>

    <form method="post" action="/qr/vcard/create" enctype="multipart/form-data" class="qr-form">

      <h2>Pers√∂nliche Informationen</h2>
      <div class="form-group-grid">
        <div><label for="first_name">Vorname *</label><input id="first_name" type="text" name="first_name" placeholder="Vorname" required></div>
        <div><label for="last_name">Nachname *</label><input id="last_name" type="text" name="last_name" placeholder="Nachname" required></div>
        <div><label for="org">Firma / Organisation</label><input id="org" type="text" name="org" placeholder="Firma / Organisation"></div>
        <div><label for="job_title">Position / Titel</label><input id="job_title" type="text" name="title" placeholder="Position / Titel"></div>
        <div><label for="email">E-Mail *</label><input id="email" type="email" name="email" placeholder="name@firma.de" required></div>
        <div><label for="phone">Telefon</label><input id="phone" type="tel" name="phone" placeholder="+49 ..."></div>
      </div>

      <h2>Adresse</h2>
      <div class="form-group-grid">
        <div><label for="address">Stra√üe & Hausnummer</label><input id="address" type="text" name="address" placeholder="Musterstra√üe 1"></div>
        <div><label for="city">Stadt</label><input id="city" type="text" name="city" placeholder="Berlin"></div>
        <div><label for="zip_code">PLZ</label><input id="zip_code" type="text" name="zip_code" placeholder="10115"></div>
        <div><label for="country">Land</label><input id="country" type="text" name="country" placeholder="Deutschland"></div>
      </div>

      <h2>Social Media</h2>
      <div class="form-group-grid">
        <div><label for="website">Website</label><input id="website" type="url" name="website" placeholder="https://..."></div>
        <div><label for="facebook">Facebook</label><input id="facebook" type="url" name="facebook" placeholder="https://facebook.com/..."></div>
        <div><label for="instagram">Instagram</label><input id="instagram" type="url" name="instagram" placeholder="https://instagram.com/..."></div>
        <div><label for="linkedin">LinkedIn</label><input id="linkedin" type="url" name="linkedin" placeholder="https://linkedin.com/in/..."></div>
        <div><label for="xing">Xing</label><input id="xing" type="url" name="xing" placeholder="https://xing.com/profile/..."></div>
        <div><label for="whatsapp">WhatsApp</label><input id="whatsapp" type="text" name="whatsapp" placeholder="+49..."></div>
      </div>

      <h2>Wallet Integration</h2>
      <div class="form-group-grid">
        <div><label for="apple_wallet_url">Apple Wallet Pass URL</label><input id="apple_wallet_url" type="url" name="apple_wallet_url" placeholder="https://..."></div>
        <div><label for="google_wallet_url">Google Wallet Pass URL</label><input id="google_wallet_url" type="url" name="google_wallet_url" placeholder="https://..."></div>
      </div>

      <h2>Profilbild</h2>
      <div class="logo-upload-box">
        <label for="create_profile_image">Profilbild hochladen (JPG, PNG, WEBP)</label>
        <input id="create_profile_image" type="file" name="profile_image" accept="image/png,image/jpeg,image/webp">
        <p>Dieses Bild wird in der digitalen vCard angezeigt.</p>
      </div>

      <h2>QR-Logo</h2>
      <div class="logo-upload-box">
        <label for="create_qr_logo">QR-Logo hochladen (JPG, PNG, WEBP)</label>
        <input id="create_qr_logo" type="file" name="qr_logo" accept="image/png,image/jpeg,image/webp">
        <p>Dieses Logo wird in der Mitte des QR-Codes platziert.</p>
      </div>

      <hr class="divider">
      {% set default_style = "modern" %}
      {% set submit_label = "‚úÖ vCard QR-Code erstellen" %}
      {% set show_logo_upload = false %}
      {% include "partials/qr_style_selector.html" %}

    </form>

  {% endif %}



  {# ============================
     MODE: VIEW
     ============================ #}
  {% if mode == "view" %}

  <div class="vc-page">
    {% if request.query_params.get("updated") == "1" %}
    <div class="vc-alert">√Ñnderungen wurden erfolgreich gespeichert.</div>
    {% endif %}
    <article class="vc-card">
      <header class="vc-head">
        {% set avatar_src = '/static/default-avatar.png' %}
        {% if vcard and (vcard.profile_image_path or vcard.logo_path) %}
          {% set profile_src = vcard.profile_image_path or vcard.logo_path %}
          {% set avatar_src = profile_src if profile_src.startswith('/') else '/' + profile_src %}
        {% elif qr and qr.logo_path %}
          {% set avatar_src = qr.logo_path if qr.logo_path.startswith('/') else '/' + qr.logo_path %}
        {% endif %}
        <img src="{{ avatar_src }}" class="vc-avatar" alt="Profilbild">
        <div class="vc-identity">
          <h1>{{ (vcard.first_name or '') ~ ' ' ~ (vcard.last_name or '') }}</h1>
          {% if vcard.title %}<p class="vc-role">{{ vcard.title }}</p>{% endif %}
          {% if vcard.org %}<p class="vc-org">{{ vcard.org }}</p>{% endif %}
        </div>
      </header>

      <div class="vc-grid">
        <section class="vc-section">
          <h2>Kontakt</h2>
          <ul>
            {% if vcard.phone %}
              <li><span>Telefon</span><a href="tel:{{ vcard.phone }}">{{ vcard.phone }}</a></li>
            {% endif %}
            {% if vcard.email %}
              <li><span>E-Mail</span><a href="mailto:{{ vcard.email }}">{{ vcard.email }}</a></li>
            {% endif %}
            {% if vcard.website %}
              <li><span>Webseite</span><a href="{{ vcard.website }}" target="_blank" rel="noopener">{{ vcard.website }}</a></li>
            {% endif %}
            {% if vcard.address or vcard.city or vcard.zip_code or vcard.country %}
              <li><span>Adresse</span>
                <span>
                  {{ vcard.address or '' }}
                  {% if vcard.zip_code or vcard.city %}, {{ vcard.zip_code or '' }} {{ vcard.city or '' }}{% endif %}
                  {% if vcard.country %}, {{ vcard.country }}{% endif %}
                </span>
              </li>
            {% endif %}
          </ul>
        </section>

        {% if vcard.facebook or vcard.instagram or vcard.linkedin or vcard.xing or vcard.whatsapp %}
        <section class="vc-section">
          <h2>Social</h2>
          <ul>
            {% if vcard.facebook %}<li><span>Facebook</span><a href="{{ vcard.facebook }}" target="_blank" rel="noopener">Profil √∂ffnen</a></li>{% endif %}
            {% if vcard.instagram %}<li><span>Instagram</span><a href="{{ vcard.instagram }}" target="_blank" rel="noopener">Profil √∂ffnen</a></li>{% endif %}
            {% if vcard.linkedin %}<li><span>LinkedIn</span><a href="{{ vcard.linkedin }}" target="_blank" rel="noopener">Profil √∂ffnen</a></li>{% endif %}
            {% if vcard.xing %}<li><span>Xing</span><a href="{{ vcard.xing }}" target="_blank" rel="noopener">Profil √∂ffnen</a></li>{% endif %}
            {% if vcard.whatsapp %}<li><span>WhatsApp</span><a href="https://wa.me/{{ (vcard.whatsapp|string)|replace('+', '')|replace(' ', '') }}">{{ vcard.whatsapp }}</a></li>{% endif %}
          </ul>
        </section>
        {% endif %}

        {% if vcard.apple_wallet_url or vcard.google_wallet_url %}
        <section class="vc-section">
          <h2>Wallet</h2>
          <ul>
            {% if vcard.apple_wallet_url %}<li><span>Apple Wallet</span><a href="{{ vcard.apple_wallet_url }}" target="_blank" rel="noopener">Pass installieren</a></li>{% endif %}
            {% if vcard.google_wallet_url %}<li><span>Google Wallet</span><a href="{{ vcard.google_wallet_url }}" target="_blank" rel="noopener">Pass installieren</a></li>{% endif %}
          </ul>
        </section>
        {% endif %}

        <aside class="vc-section vc-qr">
          {% if qr and qr.image_path %}
            <img src="/{{ qr.image_path }}" alt="QR Code">
          {% endif %}
          <p>Scannen, um diese Kontaktkarte direkt zu speichern.</p>
        </aside>
      </div>

      <footer class="vc-actions">
        <a href="/qr/vcard/{{ qr.slug }}.vcf" class="btn-primary vc-action-btn">Kontakt speichern</a>
        {% if vcard.apple_wallet_url %}
          <a href="{{ vcard.apple_wallet_url }}" target="_blank" rel="noopener" class="btn-secondary vc-action-btn">Apple Wallet</a>
        {% endif %}
        {% if vcard.google_wallet_url %}
          <a href="{{ vcard.google_wallet_url }}" target="_blank" rel="noopener" class="btn-secondary vc-action-btn">Google Wallet</a>
        {% endif %}
        <a href="/qr/vcard/edit/{{ qr.slug }}" class="btn-secondary vc-action-btn">Bearbeiten</a>
      </footer>
    </article>
  </div>

  {% endif %}



  {# ============================
     MODE: EDIT
     ============================ #}
  {% if mode == "edit" %}

    <h1>‚úèÔ∏è Visitenkarte bearbeiten</h1>
    <p class="subtitle">Alle Daten wie beim Erstellen bearbeiten und danach direkt Vorschau √∂ffnen.</p>

    <form method="post" action="/qr/vcard/update/{{ qr.id }}" enctype="multipart/form-data" class="qr-form edit-form">

      <h2>Pers√∂nliche Informationen</h2>
      <div class="form-group-grid">
        <div><label for="edit_first_name">Vorname *</label><input id="edit_first_name" type="text" name="first_name" value="{{ vcard.first_name or '' }}" placeholder="Vorname" required></div>
        <div><label for="edit_last_name">Nachname *</label><input id="edit_last_name" type="text" name="last_name" value="{{ vcard.last_name or '' }}" placeholder="Nachname" required></div>
        <div><label for="edit_org">Firma / Organisation</label><input id="edit_org" type="text" name="org" value="{{ vcard.org or '' }}" placeholder="Firma / Organisation"></div>
        <div><label for="edit_title">Position / Titel</label><input id="edit_title" type="text" name="title" value="{{ vcard.title or '' }}" placeholder="Position / Titel"></div>
        <div><label for="edit_email">E-Mail *</label><input id="edit_email" type="email" name="email" value="{{ vcard.email or '' }}" placeholder="name@firma.de" required></div>
        <div><label for="edit_phone">Telefon</label><input id="edit_phone" type="tel" name="phone" value="{{ vcard.phone or '' }}" placeholder="+49 ..."></div>
      </div>

      <h2>Adresse</h2>
      <div class="form-group-grid">
        <div><label for="edit_address">Stra√üe & Hausnummer</label><input id="edit_address" type="text" name="address" value="{{ vcard.address or '' }}" placeholder="Musterstra√üe 1"></div>
        <div><label for="edit_city">Stadt</label><input id="edit_city" type="text" name="city" value="{{ vcard.city or '' }}" placeholder="Berlin"></div>
        <div><label for="edit_zip_code">PLZ</label><input id="edit_zip_code" type="text" name="zip_code" value="{{ vcard.zip_code or '' }}" placeholder="10115"></div>
        <div><label for="edit_country">Land</label><input id="edit_country" type="text" name="country" value="{{ vcard.country or '' }}" placeholder="Deutschland"></div>
      </div>

      <h2>Social Media</h2>
      <div class="form-group-grid">
        <div><label for="edit_website">Website</label><input id="edit_website" type="url" name="website" value="{{ vcard.website or '' }}" placeholder="https://..."></div>
        <div><label for="edit_facebook">Facebook</label><input id="edit_facebook" type="url" name="facebook" value="{{ vcard.facebook or '' }}" placeholder="https://facebook.com/..."></div>
        <div><label for="edit_instagram">Instagram</label><input id="edit_instagram" type="url" name="instagram" value="{{ vcard.instagram or '' }}" placeholder="https://instagram.com/..."></div>
        <div><label for="edit_linkedin">LinkedIn</label><input id="edit_linkedin" type="url" name="linkedin" value="{{ vcard.linkedin or '' }}" placeholder="https://linkedin.com/in/..."></div>
        <div><label for="edit_xing">Xing</label><input id="edit_xing" type="url" name="xing" value="{{ vcard.xing or '' }}" placeholder="https://xing.com/profile/..."></div>
        <div><label for="edit_whatsapp">WhatsApp</label><input id="edit_whatsapp" type="text" name="whatsapp" value="{{ vcard.whatsapp or '' }}" placeholder="+49..."></div>
      </div>

      <h2>Wallet Integration</h2>
      <div class="form-group-grid">
        <div><label for="edit_apple_wallet_url">Apple Wallet Pass URL</label><input id="edit_apple_wallet_url" type="url" name="apple_wallet_url" value="{{ vcard.apple_wallet_url or '' }}" placeholder="https://..."></div>
        <div><label for="edit_google_wallet_url">Google Wallet Pass URL</label><input id="edit_google_wallet_url" type="url" name="google_wallet_url" value="{{ vcard.google_wallet_url or '' }}" placeholder="https://..."></div>
      </div>

      <h2>Profilbild</h2>
      <div class="logo-upload-box">
        <label for="edit_profile_image">Neues Profilbild hochladen (optional)</label>
        <input id="edit_profile_image" type="file" name="profile_image" accept="image/png,image/jpeg,image/webp">
        {% if vcard and vcard.profile_image_path %}
          {% set logo_src = vcard.profile_image_path if vcard.profile_image_path.startswith('/') else '/' + vcard.profile_image_path %}
          <div class="logo-preview">
            <img src="{{ logo_src }}" alt="Aktuelles Profilbild">
            <span>Aktuelles Profilbild</span>
          </div>
        {% endif %}
      </div>

      <h2>QR-Logo</h2>
      <div class="logo-upload-box">
        <label for="edit_qr_logo">Neues QR-Logo hochladen (optional)</label>
        <input id="edit_qr_logo" type="file" name="qr_logo" accept="image/png,image/jpeg,image/webp">
        {% if qr and qr.logo_path %}
          {% set logo_src = qr.logo_path if qr.logo_path.startswith('/') else '/' + qr.logo_path %}
          <div class="logo-preview">
            <img src="{{ logo_src }}" alt="Aktuelles QR-Logo">
            <span>Aktuelles QR-Logo</span>
          </div>
        {% endif %}
      </div>

      <div class="edit-actions">
        <button type="submit" class="edit-btn save">üíæ Speichern</button>
        <a href="/qr/vcard/v/{{ qr.slug }}" class="edit-btn preview">üëÅÔ∏è Vorschau</a>
      </div>

    </form>

  {% endif %}

</section>

{% if mode == "view" %}
<style>
.vc-page {
  max-width: 960px;
  margin: 1.5rem auto;
}
.vc-card {
  background: linear-gradient(160deg, #ffffff 0%, #f3f7ff 100%);
  border: 1px solid #dbe7ff;
  border-radius: 24px;
  box-shadow: 0 14px 38px rgba(13, 42, 120, 0.12);
  overflow: hidden;
}
.vc-alert {
  margin-bottom: .8rem;
  border: 1px solid #86efac;
  background: #f0fdf4;
  color: #166534;
  padding: .7rem .9rem;
  border-radius: 10px;
  font-weight: 600;
}
.vc-head {
  display: flex;
  gap: 1rem;
  align-items: center;
  padding: 1.5rem;
  background: linear-gradient(135deg, #0d2a78 0%, #1d4ed8 100%);
  color: #fff;
}
.vc-avatar {
  width: 88px;
  height: 88px;
  border-radius: 50%;
  border: 3px solid rgba(255, 255, 255, 0.6);
  object-fit: cover;
  background: #fff;
}
.vc-identity h1 {
  margin: 0;
  font-size: 1.55rem;
  line-height: 1.2;
}
.vc-role {
  margin: .25rem 0 0;
  opacity: .95;
}
.vc-org {
  margin: .2rem 0 0;
  opacity: .85;
}
.vc-grid {
  display: grid;
  grid-template-columns: 1.35fr .8fr;
  gap: 1rem;
  padding: 1.25rem 1.5rem;
}
.vc-section h2 {
  margin: 0 0 .75rem;
  font-size: 1.05rem;
  color: #0d2a78;
}
.vc-section ul {
  list-style: none;
  margin: 0;
  padding: 0;
  display: grid;
  gap: .7rem;
}
.vc-section li {
  display: grid;
  grid-template-columns: 110px 1fr;
  align-items: start;
  gap: .75rem;
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: .7rem .8rem;
}
.vc-section li span:first-child {
  color: #64748b;
  font-size: .92rem;
}
.vc-section a {
  color: #1d4ed8;
  text-decoration: none;
  word-break: break-word;
}
.vc-qr {
  text-align: center;
}
.vc-qr img {
  width: 180px;
  max-width: 100%;
  border-radius: 14px;
  border: 1px solid #dbe7ff;
  background: #fff;
  padding: .4rem;
}
.vc-qr p {
  margin: .75rem 0 0;
  color: #475569;
  font-size: .93rem;
}
.vc-actions {
  display: flex;
  gap: .7rem;
  padding: 0 1.5rem 1.4rem;
}
.vc-action-btn {
  min-width: 180px;
  text-align: center;
  font-weight: 700;
  border-radius: 12px;
  padding: .8rem 1rem;
}
@media (max-width: 860px) {
  .vc-grid {
    grid-template-columns: 1fr;
  }
  .vc-section li {
    grid-template-columns: 1fr;
    gap: .25rem;
  }
  .vc-actions {
    flex-direction: column;
  }
}
</style>
{% endif %}

{% if mode == "edit" %}
<style>
.edit-form {
  background: #ffffff;
  border: 1px solid #dbe4f5;
  border-radius: 18px;
  box-shadow: 0 8px 22px rgba(13, 42, 120, 0.08);
  padding: 1.2rem;
}
.logo-upload-box {
  border: 1px dashed #bfdbfe;
  background: #f8fbff;
  border-radius: 12px;
  padding: .9rem;
  margin-top: .5rem;
}
.logo-upload-box label {
  font-weight: 700;
}
.logo-upload-box input[type="file"] {
  margin-top: .4rem;
}
.logo-upload-box p {
  margin: .5rem 0 0;
  color: #475569;
  font-size: .9rem;
}
.logo-preview {
  margin-top: .8rem;
  display: inline-flex;
  gap: .6rem;
  align-items: center;
  background: #fff;
  border: 1px solid #dbeafe;
  border-radius: 10px;
  padding: .45rem .6rem;
}
.logo-preview img {
  width: 44px;
  height: 44px;
  border-radius: 8px;
  object-fit: cover;
}
.logo-preview span {
  color: #1e3a8a;
  font-size: .9rem;
}
.edit-form h2 {
  margin-top: 1.2rem;
}
.edit-actions {
  display: flex;
  gap: .8rem;
  margin-top: 1.2rem;
  flex-wrap: wrap;
}
.edit-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: .4rem;
  min-width: 170px;
  padding: .8rem 1rem;
  border-radius: 12px;
  font-weight: 700;
  text-decoration: none;
  border: 1px solid transparent;
  transition: transform .12s ease, box-shadow .12s ease;
}
.edit-btn:hover {
  transform: translateY(-1px);
}
.edit-btn.save {
  color: #fff;
  background: linear-gradient(135deg, #0d2a78, #1d4ed8);
  box-shadow: 0 8px 16px rgba(29, 78, 216, 0.25);
}
.edit-btn.preview {
  color: #1d4ed8;
  background: #fff;
  border-color: #93c5fd;
}
@media (max-width: 640px) {
  .edit-btn {
    width: 100%;
  }
}
</style>
{% endif %}

{% endblock %}
