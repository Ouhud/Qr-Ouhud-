{% extends "base.html" %}
{% block title %}ğŸ“„ PDF-QR-Code {% if mode == "edit" %}bearbeiten{% else %}erstellen{% endif %} â€“ Ouhud QR{% endblock %}

{% block content %}
<section class="qr-generator pdf-generator">
  <h1>ğŸ“„ PDF-QR-Code {% if mode == "edit" %}bearbeiten{% else %}erstellen{% endif %}</h1>
  <p class="subtitle">
    {% if mode == "edit" %}
      Aktualisiere deine PDF-Datei oder den Titel. Der QR-Code bleibt gleich.
    {% else %}
      Lade eine PDF-Datei hoch und erhalte einen <strong>dynamischen QR-Code-Link</strong>.<br>
      Du kannst die Datei spÃ¤ter jederzeit austauschen.
    {% endif %}
  </p>

  <!-- ğŸ§¾ Formular -->
  <form method="post" action="{% if mode == 'edit' %}/qr/pdf/update/{{ qr.id }}{% else %}/qr/pdf/generate{% endif %}" enctype="multipart/form-data" class="qr-form">
    <div class="form-group">
      <label for="title">ğŸ“ Titel:</label>
      <input type="text" id="title" name="title" value="{{ qr.title if qr else '' }}" placeholder="z. B. ProduktbroschÃ¼re 2025" required>
    </div>

    <div class="form-group">
      <label for="file">ğŸ“‚ PDF-Datei hochladen:</label>
      <input type="file" id="file" name="file" accept="application/pdf" {% if mode != "edit" %}required{% endif %} onchange="previewPdf(event)">
      {% if mode == "edit" and qr_data.pdf_path %}
        <p class="current-file">ğŸ“„ Aktuelle Datei: {{ qr_data.pdf_path.split('/')[-1] }}</p>
      {% endif %}
    </div>

    <hr class="divider">

    <!-- ğŸ¨ Stil-Auswahl -->
    {% set submit_label = "ğŸ’¾ Ã„nderungen speichern" if mode == "edit" else "âœ… QR-Code erstellen" %}
    {% include "partials/qr_style_selector.html" %}
  </form>

  {% if mode == "edit" and qr %}
  <div class="qr-result">
    <p><strong>ğŸ“ Aktueller QR-Code</strong></p>
    <img src="/{{ qr.image_path }}" alt="QR-Code" class="qr-preview">
    <p>
      <a href="/{{ qr.image_path }}" download class="download-link">â¬‡ï¸ QR-Code herunterladen</a>
    </p>
  </div>
  {% endif %}

  {% if qr_image %}
  <div class="qr-result">
    <p><strong>âœ… QR-Code erfolgreich erstellt!</strong></p>
    <img src="data:image/png;base64,{{ qr_image }}" alt="QR-Code Vorschau" class="qr-preview">
    <p>
      <a href="{{ dynamic_url }}" target="_blank" class="download-link">ğŸ“„ PDF Ã¶ffnen</a><br>
      <a href="data:image/png;base64,{{ qr_image }}" download="qr_pdf.png" class="download-link">â¬‡ï¸ QR-Code herunterladen</a>
    </p>
  </div>
  {% endif %}
</section>

<!-- === PDF-Vorschau-Skript === -->
<script>
function previewPdf(event) {
  const file = event.target.files[0];
  if (file && file.type === "application/pdf") {
    const container = document.getElementById("pdf-preview-container") || document.createElement("div");
    container.id = "pdf-preview-container";
    container.classList.add("pdf-preview-container");

    const preview = document.createElement("embed");
    preview.src = URL.createObjectURL(file);
    preview.type = "application/pdf";
    preview.classList.add("pdf-preview");

    container.innerHTML = '<p class="preview-label">ğŸ“„ Vorschau:</p>';
    container.appendChild(preview);

    document.querySelector(".qr-form").insertAdjacentElement("afterend", container);
  }
}
</script>

<style>
.current-file {
  font-size: 0.9rem;
  color: #0D2A78;
  margin-top: 0.5rem;
}
</style>
{% endblock %}
