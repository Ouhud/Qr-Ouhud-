{% extends "base.html" %}
{% block title %}üìä Dashboard ‚Äì Ouhud QR{% endblock %}

{% block content %}
<section class="dashboard">
  <h1 class="dashboard-title">üìä Dashboard</h1>
  <p class="dashboard-subtitle">
    √úberblick √ºber deine QR-Codes, Scans und Nutzeraktivit√§t in Echtzeit.
  </p>

  <!-- === KPI-CARDS (OBEN) === -->
  <div class="dashboard-cards">
    <div class="card">
      <h2>{{ total_qrcodes }}</h2>
      <p>Gesamt-QR-Codes</p>
    </div>
    <div class="card">
      <h2>{{ total_scans }}</h2>
      <p>Gesamte Scans</p>
    </div>
    <div class="card">
      <h2>{{ active_qr_codes }}</h2>
      <p>Aktive QR-Codes</p>
    </div>
    <div class="card">
      <h2>{{ scans_today }}</h2>
      <p>Neue Scans heute</p>
    </div>
  </div>

  <!-- === CHARTS === -->
  <div class="chart-grid">
    <div class="chart-card">
      <h3>üíº Abo & QR-Limit ({{ plan_display_name }})</h3>
      <p class="usage-meta">
        Verwendet: <strong>{{ qr_usage }}</strong>{% if not qr_unlimited %} / {{ qr_limit_display }}{% endif %} |
        Verf√ºgbar: <strong>{{ qr_remaining_display }}</strong> |
        Auslastung: <strong>{{ qr_usage_percent_label }}</strong>
      </p>
      <div class="chart-canvas chart-canvas-usage">
        <canvas id="usageChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <h3>üìà Scans ({{ range_title }})</h3>
        <div class="range-filter">
          <a href="/dashboard/?range=7d" class="{% if range_key == '7d' %}active{% endif %}">7 Tage</a>
          <a href="/dashboard/?range=30d" class="{% if range_key == '30d' %}active{% endif %}">30 Tage</a>
          <a href="/dashboard/?range=6m" class="{% if range_key == '6m' %}active{% endif %}">6 Monate</a>
        </div>
      </div>
      <div class="chart-canvas chart-canvas-scans">
        <canvas id="scansChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <h3>üß≠ Conversion-Funnel</h3>
      <p class="usage-meta">
        Conversion-Rate (Visits ‚Üí Conversions): <strong>{{ conversion_rate_label }}</strong>
      </p>
      <div class="chart-canvas chart-canvas-funnel">
        <canvas id="funnelChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <h3>üîù Top 10 QR-Codes (Scans)</h3>
      <div class="chart-canvas chart-canvas-top">
        <canvas id="topQrChart"></canvas>
      </div>
    </div>

    <div class="chart-card chart-card-wide">
      <h3>üî• Scan-Heatmap (Tag √ó Stunde)</h3>
      <div class="chart-canvas chart-canvas-heatmap">
        <canvas id="heatmapChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <h3>üìä Verteilung der QR-Typen</h3>
      <div class="chart-canvas chart-canvas-pie">
        <canvas id="typeChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <h3>üì± Ger√§teverteilung</h3>
      <div class="chart-canvas chart-canvas-pie">
        <canvas id="deviceChart"></canvas>
      </div>
    </div>
  </div>

  <!-- === LETZTE SCANS === -->
  <div class="table-card">
    <h3>üïì Letzte Scans ({{ range_title }})</h3>
    <table>
      <thead>
        <tr><th>Datum</th><th>Typ</th><th>Slug</th><th>Ort</th><th>Ger√§t</th></tr>
      </thead>
      <tbody>
        {% for scan in recent_scans %}
        <tr>
          <td>{{ scan.date }}</td>
          <td>{{ scan.type }}</td>
          <td><code>{{ scan.slug }}</code></td>
          <td>{{ scan.location }}</td>
          <td>{{ scan.device }}</td>
        </tr>
        {% else %}
        <tr><td colspan="5">Keine Scans im gew√§hlten Zeitraum vorhanden</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<!-- === üìä Chart.js === -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2"></script>
<script>
const baseChartOptions = {
  responsive: true,
  maintainAspectRatio: false,
  animation: { duration: 450 }
};

/* === LINE CHART: Scans Zeitraum === */
new Chart(document.getElementById("scansChart"), {
  type: 'line',
  data: {
    labels: {{ (chart_labels or []) | tojson }},
    datasets: [{
      data: {{ (scans_per_period or []) | tojson }},
      fill: true,
      tension: 0.35,
      borderColor: "#2563EB",
      backgroundColor: "rgba(37,99,235,0.15)",
      pointBackgroundColor: "#2563EB",
      pointRadius: 4
    }]
  },
  options: {
    ...baseChartOptions,
    plugins:{ legend:{ display:false }},
    scales:{
      x:{ ticks:{ autoSkip:true, maxRotation:0 } },
      y:{ beginAtZero:true, ticks:{ precision:0 } }
    }
  }
});

/* === DOUGHNUT CHART: QR-Typen === */
new Chart(document.getElementById("typeChart"), {
  type: 'doughnut',
  data: {
    labels: {{ (qr_type_labels or []) | tojson }},
    datasets: [{
      data: {{ (qr_type_counts or []) | tojson }},
      backgroundColor: [
        "#2563EB","#0d2a78","#38bdf8","#10b981",
        "#facc15","#f97316","#ef4444"
      ],
      borderWidth: 0
    }]
  },
  options: {
    ...baseChartOptions,
    plugins:{ legend:{ position:"bottom" } }
  }
});

/* === BAR CHART: Top 10 QR === */
new Chart(document.getElementById("topQrChart"), {
  type: "bar",
  data: {
    labels: {{ (top_qr_labels or []) | tojson }},
    datasets: [
      {
        label: "Aktueller Zeitraum",
        data: {{ (top_qr_current or []) | tojson }},
        backgroundColor: "#2563EB",
        borderRadius: 8,
      },
      {
        label: "Vorzeitraum",
        data: {{ (top_qr_previous or []) | tojson }},
        backgroundColor: "#93c5fd",
        borderRadius: 8,
      },
    ],
  },
  options: {
    ...baseChartOptions,
    indexAxis: "y",
    plugins: {
      legend: { position: "bottom" },
      tooltip: {
        callbacks: {
          afterBody: function(context) {
            const idx = context[0]?.dataIndex ?? 0;
            const deltas = {{ (top_qr_delta_pct or []) | tojson }};
            const delta = deltas[idx] ?? 0;
            const sign = delta > 0 ? "+" : "";
            return `Trend vs. Vorzeitraum: ${sign}${delta}%`;
          }
        }
      }
    },
    scales: {
      x: { beginAtZero: true, ticks: { precision: 0 } },
      y: {
        ticks: {
          callback: function(value) {
            const label = String(this.getLabelForValue(value) || "");
            return label.length > 22 ? `${label.slice(0, 22)}...` : label;
          }
        }
      }
    }
  }
});

/* === MATRIX CHART: Heatmap Tag √ó Stunde === */
const heatmapData = {{ (heatmap_points or []) | tojson }};
const heatmapMax = {{ heatmap_max or 1 }};
const heatmapDayLabels = {{ (heatmap_day_labels or []) | tojson }};

try {
  new Chart(document.getElementById("heatmapChart"), {
    type: "matrix",
    data: {
      datasets: [{
        label: "Scans",
        data: heatmapData,
        width: ({ chart }) => {
          const area = chart.chartArea || { width: 600 };
          return Math.max(8, (area.width / 24) - 1);
        },
        height: ({ chart }) => {
          const area = chart.chartArea || { height: 220 };
          return Math.max(14, (area.height / 7) - 1);
        },
        backgroundColor: (ctx) => {
          const value = Number(ctx.raw?.v || 0);
          if (!value) return "rgba(226,232,240,0.6)";
          const alpha = Math.min(0.95, 0.15 + (value / Math.max(1, heatmapMax)) * 0.8);
          return `rgba(37,99,235,${alpha})`;
        },
        borderWidth: 0,
      }]
    },
    options: {
      ...baseChartOptions,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: (items) => {
              const p = items?.[0]?.raw || {};
              const day = heatmapDayLabels[p.y] || "";
              const hour = String(p.x ?? 0).padStart(2, "0");
              return `${day} ${hour}:00`;
            },
            label: (item) => `Scans: ${item.raw?.v || 0}`,
          }
        }
      },
      scales: {
        x: {
          type: "linear",
          min: -0.5,
          max: 23.5,
          ticks: {
            stepSize: 1,
            callback: function(v) {
              const w = this?.chart?.width || 900;
              const step = w < 520 ? 6 : (w < 760 ? 4 : 3);
              return v % step === 0 ? `${String(v).padStart(2, "0")}:00` : "";
            }
          },
          grid: { display: false }
        },
        y: {
          type: "linear",
          min: -0.5,
          max: 6.5,
          ticks: {
            stepSize: 1,
            callback: (v) => heatmapDayLabels[v] || ""
          },
          grid: { display: false }
        }
      }
    }
  });
} catch (e) {
  console.warn("Heatmap konnte nicht gerendert werden:", e);
}

/* === FUNNEL (Bar) === */
new Chart(document.getElementById("funnelChart"), {
  type: "bar",
  data: {
    labels: {{ (funnel_labels or []) | tojson }},
    datasets: [{
      data: {{ (funnel_values or []) | tojson }},
      backgroundColor: ["#1d4ed8", "#2563EB", "#10b981"],
      borderRadius: 10,
    }]
  },
  options: {
    ...baseChartOptions,
    indexAxis: "y",
    plugins: { legend: { display: false } },
    scales: { x: { beginAtZero: true, ticks: { precision: 0 } } }
  }
});

/* === PIE CHART: Ger√§te === */
new Chart(document.getElementById("deviceChart"), {
  type: 'pie',
  data: {
    labels: {{ (device_labels or []) | tojson }},
    datasets: [{
      data: {{ (device_counts or []) | tojson }},
      backgroundColor: ["#2563EB","#10b981","#f59e0b","#94a3b8"],
      borderWidth: 0
    }]
  },
  options: {
    ...baseChartOptions,
    plugins:{ legend:{ position:"bottom" } }
  }
});

/* === PROGRESS CHART: QR-Limit Nutzung === */
const qrUnlimited = {{ (qr_unlimited or false) | tojson }};
const usageLabels = qrUnlimited ? ["Intern frei"] : ["Verwendet", "Verf√ºgbar"];
const usageData = qrUnlimited ? [1] : [{{ qr_usage or 0 }}, {{ qr_remaining or 0 }}];
const usageColors = qrUnlimited ? ["#10b981"] : ["#2563EB", "#e2e8f0"];

new Chart(document.getElementById("usageChart"), {
  type: 'doughnut',
  data: {
    labels: usageLabels,
    datasets: [{
      data: usageData,
      backgroundColor: usageColors,
      borderWidth: 0
    }]
  },
  options: {
    ...baseChartOptions,
    cutout: "70%",
    plugins:{
      legend:{ display:false },
      tooltip:{ enabled:true }
    }
  }
});
</script>

<!-- === STYLE SECTION === -->
<style>
:root {
  --primary:#0d2a78;
  --accent:#2563EB;
  --bg:#f8f9fc;
  --text:#1e293b;
  --muted:#64748b;
}

/* === DASHBOARD === */
.dashboard {
  padding:2rem;
  max-width:1200px;
  margin:0 auto;
  font-family:system-ui, sans-serif;
}
.dashboard-title {
  font-size:1.9rem;
  font-weight:700;
  color:var(--primary);
}
.dashboard-subtitle {
  color:var(--muted);
  margin-bottom:2rem;
}

/* === KPI-CARDS === */
.dashboard-cards {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:1rem;
  margin-bottom:2rem;
}
.card {
  background:#fff;
  border-radius:1rem;
  box-shadow:0 3px 10px rgba(0,0,0,0.05);
  text-align:center;
  padding:1.3rem;
  transition:transform .2s ease, box-shadow .2s ease;
}
.card:hover {
  transform:translateY(-4px);
  box-shadow:0 5px 18px rgba(13,42,120,0.15);
}
.card h2 {
  font-size:2rem;
  color:var(--primary);
  margin:0;
}
.card p {
  color:var(--muted);
  font-size:.95rem;
}

/* === CHART-GRID === */
.chart-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(340px,1fr));
  gap:1.5rem;
  margin-bottom:2.5rem;
}
.chart-card {
  background:#fff;
  border-radius:1rem;
  box-shadow:0 3px 10px rgba(0,0,0,0.05);
  padding:1.2rem;
}
.chart-card-wide {
  grid-column: span 2;
}
.chart-card h3 {
  color:var(--primary);
  font-size:1rem;
  margin-bottom:.4rem;
}
.chart-canvas {
  position: relative;
  width: 100%;
}
.chart-canvas canvas {
  width: 100% !important;
  height: 100% !important;
  display: block;
}
.chart-canvas-usage { height: 250px; }
.chart-canvas-scans { height: 300px; }
.chart-canvas-funnel { height: 250px; }
.chart-canvas-top { height: 320px; }
.chart-canvas-heatmap { height: 320px; }
.chart-canvas-pie { height: 280px; }
.usage-meta {
  margin:0 0 .8rem;
  color:var(--muted);
  font-size:.92rem;
}
.chart-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:.7rem;
  margin-bottom:.8rem;
}
.range-filter {
  display:flex;
  align-items:center;
  gap:.35rem;
  flex-wrap: wrap;
}
.range-filter a {
  text-decoration:none;
  border:1px solid #cbd5e1;
  padding:.25rem .55rem;
  border-radius:999px;
  font-size:.8rem;
  color:#334155;
  background:#fff;
}
.range-filter a.active {
  border-color:#2563EB;
  background:#eff6ff;
  color:#1d4ed8;
  font-weight:600;
}

/* === TABLE === */
.table-card {
  background:#fff;
  border-radius:1rem;
  box-shadow:0 3px 10px rgba(0,0,0,0.05);
  padding:1.5rem;
  overflow-x:auto;
}
.table-card h3 {
  color:var(--primary);
  font-size:1.1rem;
  margin-bottom:1rem;
}
table {
  width:100%;
  border-collapse:collapse;
  font-size:.95rem;
}
thead {
  background:#f1f5f9;
  color:#334155;
}
th,td {
  padding:.8rem 1rem;
  border-bottom:1px solid #e2e8f0;
  text-align:left;
}
tbody tr:hover { background:#f9fafb; }

/* === SPLIT-SCREEN / HALBE DESKTOP-BREITE === */
@media (max-width:1280px) {
  .dashboard {
    max-width: 100%;
    padding: 1.25rem;
  }
  .chart-grid {
    grid-template-columns: 1fr;
  }
  .chart-card-wide {
    grid-column: span 1;
  }
  .chart-canvas-usage { height: 230px; }
  .chart-canvas-scans { height: 260px; }
  .chart-canvas-funnel { height: 230px; }
  .chart-canvas-top { height: 300px; }
  .chart-canvas-heatmap { height: 280px; }
  .chart-canvas-pie { height: 250px; }
}

/* === RESPONSIVE === */
@media (max-width:768px) {
  .dashboard { padding:1rem; }
  .chart-grid { grid-template-columns:1fr; }
  .chart-card-wide { grid-column: span 1; }
  .chart-card { padding:1rem; }
  .chart-canvas-usage { height: 220px; }
  .chart-canvas-scans { height: 260px; }
  .chart-canvas-funnel { height: 220px; }
  .chart-canvas-top { height: 280px; }
  .chart-canvas-heatmap { height: 260px; }
  .chart-canvas-pie { height: 240px; }
  table { font-size:.85rem; }
  .chart-header { flex-direction:column; align-items:flex-start; }
}
@media (max-width:480px) {
  .dashboard-cards {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
  .card h2 { font-size:1.55rem; }
  .card p { font-size:.85rem; }
  .range-filter { flex-wrap:wrap; }
  .range-filter a { font-size:.75rem; }
}
</style>
{% endblock %}
